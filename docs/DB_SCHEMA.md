# Database Schema (Board-Game-Recommendation)

## 1. Scope
This document is the human-readable schema overview for the PostgreSQL database (`recommend`) used by this project.

Source of truth:
- Sequelize migrations in `server/migrations/`

If schema changes, update:
1. Migration files
2. This document (`docs/DB_SCHEMA.md`)

---

## 2. Tables Overview

### `users`
Purpose:
- Store account/profile data and recommendation preference states.

Columns:
- `id` (INTEGER, PK, auto-increment)
- `email` (VARCHAR(255), NOT NULL)
- `password` (VARCHAR(255), NOT NULL)
- `firstname` (VARCHAR(30))
- `lastname` (VARCHAR(30))
- `username` (VARCHAR(255), NOT NULL, UNIQUE)
- `url` (VARCHAR(255)) - avatar path
- `preference` (BOOLEAN, NOT NULL, default `false`)
- `preference_list` (INTEGER[], NOT NULL, default `[]`)
- `preference_list1` (BOOLEAN[], NOT NULL, default `[]`)

Constraints / Indexes:
- UNIQUE `username`
- UNIQUE index `users_email_lower_unique` on `LOWER(email)` (case-insensitive email uniqueness)

Referenced by:
- `chats.user1_id -> users.id`
- `chats.user2_id -> users.id`
- `messages.sender_id -> users.id`
- `user_ratings.user_id -> users.id`

---

### `board_games`
Purpose:
- Store searchable board game metadata used by dashboard/search/recommendation display.

Columns:
- `bggid` (INTEGER, PK)
- `name` (VARCHAR(255), NOT NULL)
- `description` (TEXT)
- `yearpublished` (INTEGER)
- `avgrating` (DOUBLE PRECISION)
- `minplayers` (INTEGER)
- `maxplayers` (INTEGER)
- `numuserratings` (INTEGER)
- `imagepath` (TEXT)

Indexes:
- B-tree index on `name`

Referenced by:
- `user_ratings.game_id -> board_games.bggid`

---

### `user_ratings`
Purpose:
- Store user rating per game for collaborative filtering and personalization.

Columns:
- `id` (INTEGER, PK, auto-increment)
- `user_id` (INTEGER, NOT NULL, FK -> `users.id`)
- `game_id` (INTEGER, NOT NULL, FK -> `board_games.bggid`)
- `rating` (DOUBLE PRECISION, NOT NULL)

Constraints:
- UNIQUE (`user_id`, `game_id`) as `unique_user_game_rating`

Indexes:
- B-tree index on `user_id`
- B-tree index on `game_id`

---

### `chats`
Purpose:
- Store 1:1 chat room pairs.

Columns:
- `chat_id` (INTEGER, PK, auto-increment)
- `user1_id` (INTEGER, FK -> `users.id`)
- `user2_id` (INTEGER, FK -> `users.id`)

Constraints:
- UNIQUE (`user1_id`, `user2_id`) as `unique_user_pair`

Referenced by:
- `messages.chat_id -> chats.chat_id`

---

### `messages`
Purpose:
- Store message rows for each chat.

Columns:
- `message_id` (INTEGER, PK, auto-increment)
- `chat_id` (INTEGER, FK -> `chats.chat_id`)
- `sender_id` (INTEGER, FK -> `users.id`)
- `content` (TEXT, NOT NULL)
- `sent_at` (TIMESTAMPTZ, default `CURRENT_TIMESTAMP`)

---

### `SequelizeMeta`
Purpose:
- Internal Sequelize migration history table.

---

## 3. Relationship Diagram (Logical)

- `users` 1 --- n `user_ratings`
- `board_games` 1 --- n `user_ratings`
- `users` 1 --- n `messages` (via `sender_id`)
- `chats` 1 --- n `messages`
- `users` --- `chats` (pair relation via `user1_id`, `user2_id`)

---

## 4. Initialization Strategy

Current strategy:
- Schema is created/updated by Sequelize migrations (`pnpm migrate`).
- In Docker Compose, one-shot services run before `server` startup:
  1. `migrate` (Sequelize schema migration)
  2. `seed_board_games` (data seed from `games.pkl`)

Recommended data population:
- `users`: no preload required (created by signup flow)
- `board_games`: seed/import from `api_cf/model_data/games.pkl` (recommended, automated in compose)
- `user_ratings`: optional preload; can be generated by user interaction
- `chats/messages`: optional preload

Seed runtime behavior:
- `seed_board_games` skips import when `board_games` already has rows (faster startup).
- To force reseed, set `SEED_FORCE=1` for the `seed_board_games` service.

Seed mapping (`games.pkl` -> `board_games`):
- `BGGId` -> `bggid`
- `Name` -> `name`
- `Description` -> `description`
- `YearPublished` -> `yearpublished`
- `AvgRating` -> `avgrating`
- `MinPlayers` -> `minplayers`
- `MaxPlayers` -> `maxplayers`
- `NumUserRatings` -> `numuserratings`
- `ImagePath` -> `imagepath`

---

## 5. Migration Files (Current)

- `server/migrations/20240726071017-create-user.js`
- `server/migrations/20240726071147-create-chat.js`
- `server/migrations/20240726071208-create-message.js`
- `server/migrations/20260216234000-add-recommendation-columns-to-users.js`
- `server/migrations/20260216234100-create-board-games.js`
- `server/migrations/20260216234200-create-user-ratings.js`
- `server/migrations/20260219161000-enforce-unique-user-email.js`

---

## 6. Update Rule

Whenever schema changes:
1. Add/modify migration(s)
2. Update this file's table definitions/relationships/migration list in the same PR
